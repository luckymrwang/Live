name: Update

on:
  watch:
    types: [started]
  schedule:
    - cron: 0 */6 * * *
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
          token: ${{ secrets.LIVELIST }}

    - name: GetTime
      run: echo "DATE=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV

    - name: Update
      run: |
        # 央视源
        rm -f CCTV.m3u && wget https://raw.githubusercontent.com/Kimentanm/aptv/master/m3u/iptv.m3u -O CCTV.m3u
        sed -i -n '/央视IPV4/,+1p' CCTV.m3u
        sed -i '1i #EXTM3U' CCTV.m3u
        sed -i '/^\s*$/d' CCTV.m3u

        # 卫视源
        rm -f CNTV.m3u && touch CNTV.m3u
        wget https://raw.githubusercontent.com/Kimentanm/aptv/master/m3u/iptv.m3u -O CNTV1.m3u && sed -i -n '/卫视IPV4/,+1p' CNTV1.m3u
        wget https://raw.githubusercontent.com/Kimentanm/aptv/master/m3u/iptv.m3u -O CNTV2.m3u && sed -i -n '/春晚/,+1p' CNTV2.m3u
        cat CNTV1.m3u >> CNTV.m3u
        cat CNTV2.m3u >> CNTV.m3u
        rm -f CNTV1.m3u CNTV2.m3u
        sed -i '1i #EXTM3U' CNTV.m3u
        sed -i '/^\s*$/d' CNTV.m3u

        # 整合源
        rm -f IPTV.m3u && touch IPTV.m3u
        cat CCTV.m3u >> IPTV.m3u
        cat CNTV.m3u >> IPTV.m3u
        sed -i '/#EXTM3U/d' IPTV.m3u
        sed -i '1i #EXTM3U' IPTV.m3u
        sed -i '/^\s*$/d' IPTV.m3u

        # 节目源
        rm -f EPG.xml && wget https://epg.112114.xyz/pp.xml -O EPG.xml
        echo "Auto Update IPTV(ipv6) in $DATE,基于Moexin/IPTV项目修改,国内直播源同步fanmingming/live" > README.md


    # ==============================
    # 生成 IPTV2.m3u
    # ==============================
    - name: Generate IPTV2.m3u
      run: |
        python <<'EOF'
        import requests
        import time
        from concurrent.futures import ThreadPoolExecutor

        TIMEOUT = 6
        MAX_WORKERS = 30

        M3U_URL = "https://raw.githubusercontent.com/suxuang/myIPTV/main/ipv4.m3u"

        # ==========================
        # 拉取远程 M3U
        # ==========================
        def fetch_m3u(url):
            r = requests.get(url, timeout=10)
            r.raise_for_status()
            return r.text.splitlines()

        # ==========================
        # 解析 + 过滤
        # ==========================
        def should_filter(name):
            name_upper = name.upper()

            keywords = [
                "CGTN",
                "国际",
                "翡翠",
                "TVB",
                "JADE",
                "香港",
                "RT"
            ]

            for k in keywords:
                if k in name_upper:
                    return True
            return False


        def parse_m3u_lines(lines):
            items = []
            name = None
            for line in lines:
                line = line.strip()
                if line.startswith("#EXTINF"):
                    name = line.split(",")[-1]
                elif line and not line.startswith("#"):
                    if name:
                        if not should_filter(name):
                            items.append((name, line))
                        name = None
            return items

        # ==========================
        # 检测
        # ==========================
        def check_stream(item):
            name, url = item
            try:
                start = time.time()
                r = requests.head(url, timeout=TIMEOUT, allow_redirects=True)
                delay = time.time() - start
                if r.status_code == 200:
                    return (name, url, delay, True)
            except:
                pass
            return (name, url, None, False)

        # ===== 主流程 =====
        lines = fetch_m3u(M3U_URL)
        playlist = parse_m3u_lines(lines)

        results = []
        with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
            for r in executor.map(check_stream, playlist):
                results.append(r)

        valid = [r for r in results if r[3]]

        with open("IPTV2.m3u", "w", encoding="utf-8") as out:
            out.write("#EXTM3U\n")
            for name, url, delay, _ in valid:
                out.write(f"#EXTINF:-1,{name} (delay={round(delay,2)}s)\n")
                out.write(f"{url}\n")

        print("过滤后频道数:", len(playlist))
        print("有效频道:", len(valid))
        EOF


    - name: Clean
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git checkout --orphan latest_branch
        git add -A
        git commit -am "$DATE"
        git branch -D main
        git branch -m main

    - name: Push
      run: git push -f origin main
